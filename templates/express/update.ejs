import * as express from "express";
import { HttpError } from './HttpError';
import { cleanBody } from './cleanBody';
import { <%= schema.entitySingularUc %>, <%= schema.interfaceModel %> } from './<%= schema.entitySingularUc %>';

interface IUpdateCB {
  (err: Error|HttpError, savedRow?: <%= schema.interfaceModel %>)
};

export function update(/*user,*/ row: <%= schema.interfaceModel %>, data, next: IUpdateCB) {
  cleanBody(data);

  // TODO
  //data = meta.$express.restricted_filter(log, user, 'update', data);

  // TODO review this!
  row.set(data);

  row.save(function(err, savedRow) {
    /* istanbul ignore next */ if (err) {
      return next(err);
    }

    /* istanbul ignore next */
    if (!savedRow) {
      return next(new HttpError(422, 'database don\'t return data'));
    }

    return next(null, savedRow);
  });
}

export function <%= schema.backend.updateFunction %>(req: express.Request, res: express.Response, next: express.NextFunction) {
  console.info('update body', req.body);

  if (Array.isArray(req.body)) {
    return next(new HttpError(422, 'body is an array'));
  }

  if (!req[<%= JSON.stringify(schema.entitySingular) %>]) {
   return next(new HttpError(500, 'Cannot fetch <%= schema.singular %>'));
  }

  return update(/*req.user, */req[<%= JSON.stringify(schema.entitySingular) %>], req.body, function(err, savedRow: <%= schema.interfaceModel %>) {
    /* istanbul ignore next */ if (err) {
      return next(err);
    }

    console.info('created@database', savedRow);

    req[<%= JSON.stringify(schema.entitySingular) %>] = savedRow;
    return next();
  });
}


